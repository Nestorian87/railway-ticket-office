<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Головна – Залізнична каса</title>
    <link rel="icon" href="img/logo.png" type="image/png">
</head>
<body class="bg-light">
<header>
    <%- include('partials/header'); %>
</header>
<div class="background-image"></div>
<main>
    <div class="container mt-5">
        <div class="card p-3 shadow-sm" style="border-radius: 15px; background-color: #f8f9fa;">
            <form action="/search">
                <div class="row g-2 align-items-center justify-content-center">
                    <input type="hidden" name="fromStationId" id="fromStationId">
                    <input type="hidden" name="toStationId" id="toStationId">

                    <div class="col-md-3 position-relative">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="fromStationInput" placeholder="Звідки"
                                   autocomplete="off" required>
                            <label for="fromStationInput">Звідки</label>
                        </div>
                        <ul class="dropdown-menu w-100" id="fromStationDropdown"
                            style="max-height: 200px; overflow-y: auto;">
                        </ul>
                    </div>

                    <div class="col-auto text-center">
                        <button type="button" class="btn btn-outline-primary" id="swapBtn">
                            <i class="bi bi-arrow-left-right fs-5"></i>
                        </button>
                    </div>

                    <div class="col-md-3 position-relative">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="toStationInput" placeholder="Куди"
                                   autocomplete="off" required>
                            <label for="toStationInput">Куди</label>
                        </div>
                        <ul class="dropdown-menu w-100" id="toStationDropdown"
                            style="max-height: 200px; overflow-y: auto;">
                        </ul>
                    </div>

                    <div class="col-md-3">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="travelDate" name="date" required
                                   value="<%= new Date().toISOString().split('T')[0] %>"
                                   min="<%= new Date().toISOString().split('T')[0] %>"
                                   max="<%= new Date(new Date().setMonth(new Date().getMonth() + 2)).toISOString().split('T')[0] %>">
                            <label for="travelDate">Дата</label>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <input class="btn btn-primary w-100" type="submit" style="height: 58px;" value="Знайти">
                    </div>
                </div>
            </form>
        </div>
    </div>

</main>
<script>
    const stations = <%- JSON.stringify(stations) %>;

    function filterStations(input, dropdown, stationIdInput, anotherStationIdInput) {
        dropdown.innerHTML = "";
        const filteredStations = stations.filter(station =>
            +anotherStationIdInput.value !== station.station_id &&
            station.station_name.toLowerCase().includes(input.value.toLowerCase())
        );

        filteredStations.forEach(station => {
            const listItem = document.createElement("li");
            listItem.classList.add("dropdown-item");
            listItem.textContent = station.station_name;
            listItem.onclick = () => {
                input.value = station.station_name;
                stationIdInput.value = station.station_id;
                dropdown.innerHTML = "";
            };
            dropdown.appendChild(listItem);
        });

        if (filteredStations.length === 0) {
            const listItem = document.createElement("li");
            listItem.classList.add("dropdown-item");
            listItem.classList.add("disabled");
            listItem.textContent = "Станцію не знайдено";
            stationIdInput.value = "";
            dropdown.appendChild(listItem);
        }

        dropdown.classList.toggle("show", true);
    }

    const fromStationInput = document.getElementById("fromStationInput");
    const fromStationDropdown = document.getElementById("fromStationDropdown");
    const fromStationIdInput = document.getElementById("fromStationId");

    fromStationInput.addEventListener("input", () => {
        filterStations(fromStationInput, fromStationDropdown, fromStationIdInput, toStationIdInput);
    });

    fromStationInput.addEventListener("click", () => {
        filterStations(fromStationInput, fromStationDropdown, fromStationIdInput, toStationIdInput);
    });

    fromStationInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            const firstItem = fromStationDropdown.querySelector(".dropdown-item:not(.disabled)");
            if (firstItem) {
                e.preventDefault();
                firstItem.click();
            }
        }
    });

    const toStationInput = document.getElementById("toStationInput");
    const toStationDropdown = document.getElementById("toStationDropdown");
    const toStationIdInput = document.getElementById("toStationId");

    toStationInput.addEventListener("input", () => {
        filterStations(toStationInput, toStationDropdown, toStationIdInput, fromStationIdInput);
    });

    toStationInput.addEventListener("click", () => {
        filterStations(toStationInput, toStationDropdown, toStationIdInput, fromStationIdInput);
    });

    toStationInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            const firstItem = toStationDropdown.querySelector(".dropdown-item:not(.disabled)");
            if (firstItem) {
                e.preventDefault()
                firstItem.click();
            }
        }
    });

    document.addEventListener("click", (e) => {
        if (!e.target.closest("#fromStationInput") && !e.target.closest("#fromStationDropdown")) {
            document.getElementById("fromStationDropdown").classList.remove("show");
            if (!fromStationIdInput.value) {
                fromStationInput.value = "";
            }
        }
        if (!e.target.closest("#toStationInput") && !e.target.closest("#toStationDropdown")) {
            document.getElementById("toStationDropdown").classList.remove("show");
            if (!toStationIdInput.value) {
                toStationInput.value = "";
            }
        }
    });

    document.getElementById('swapBtn').addEventListener('click', () => {
        const fromStationName = fromStationInput.value;
        const fromStationId = fromStationIdInput.value;
        const toStationName = toStationInput.value;
        const toStationId = toStationIdInput.value;

        fromStationInput.value = toStationName
        fromStationIdInput.value = toStationId
        toStationInput.value = fromStationName
        toStationIdInput.value = fromStationId
    });
</script>
</body>
</html>