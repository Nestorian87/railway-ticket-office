<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Профіль – Залізнична каса</title>
    <link rel="icon" href="img/logo.png" type="image/png">
</head>
<body class="bg-light">
<header style="padding-bottom: 60px;">
    <%- include('partials/header'); %>
</header>
<main>
    <section class="profile-header text-center bg-white">
        <div class="container p-3">
            <div class="container d-flex justify-content-center align-items-center gap-3">
                <h2 class="card-title fs-3 mb-0"><%= user.getFullName() %></h2>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal"><i class="bi bi-pencil"></i></button>
            </div>

            <p class="card-text mb-1">
                <strong>Електронна пошта:</strong> <%= user.email %>
            </p>
            <p class="card-text mb-1">
                <strong>Телефон:</strong> <%= user.phone_number %>
            </p>
        </div>
        <hr>
    </section>
    <section class="container mt-4 text-center mt-5">
        <h3>Мої пасажири</h3>
        <table class="table table-striped table-hover mt-4">
            <thead>
            <tr>
                <th scope="col">Імʼя</th>
                <th scope="col">Прізвище</th>
                <th scope="col">Пільга</th>
                <th scope="col">Пільговий документ</th>
                <th scope="col">Номер пільгового документу</th>
                <th scope="col">Дії</th>
            </tr>
            </thead>
            <tbody>
            <% user.passengers.forEach(passenger => { %>
                <tr>
                    <td><%= passenger.passenger_first_name %></td>
                    <td><%= passenger.passenger_last_name %></td>
                    <td><%= passenger.benefit ? passenger.benefit.benefit_name : '–' %></td>
                    <td><%= passenger.benefit ? passenger.benefit.document_name : '–' %></td>
                    <td><%= passenger.benefit ? passenger.benefit_document : '–' %></td>
                    <td>
                        <button class="btn btn-sm btn-warning me-2" data-bs-toggle="modal"
                                data-bs-target="#editPassengerModal"
                                onclick="showEditForm(<%= passenger.passenger_id %>, '<%= passenger.passenger_first_name %>', '<%= passenger.passenger_last_name %>', <%= passenger.benefit ? passenger.benefit.benefit_id : 'null' %>, '<%= passenger.benefit_document %>')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#deletePassengerModal"
                                data-bs-passenger-id="<%= passenger.passenger_id %>"
                                data-bs-passenger-name="<%= passenger.getFullName() %>">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            <% }) %>
            </tbody>
        </table>

        <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPassengerModal">Додати пасажира
            </button>
        </div>
    </section>

    <div class="modal fade" id="addPassengerModal" tabindex="-1" aria-labelledby="addPassengerModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPassengerModalLabel">Додати пасажира</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPassengerForm" action="/add-passenger" method="POST">
                        <div class="mb-3">
                            <label for="passengerName" class="form-label">Імʼя</label>
                            <input type="text" class="form-control" id="passengerName" name="firstName" required>
                        </div>
                        <div class="mb-3">
                            <label for="passengerSurname" class="form-label">Прізвище</label>
                            <input type="text" class="form-control" id="passengerSurname" name="lastName" required>
                        </div>
                        <div class="mb-3">
                            <label for="addBenefit" class="form-label">Пільга</label>
                            <select class="form-select" id="addBenefit" name="benefitId">
                                <option value="">Без пільги</option>
                                <% benefits.forEach(benefit => { %>
                                    <option value="<%= benefit.benefit_id %>"
                                            data-document="<%= benefit.document_name %>">
                                        <%= benefit.benefit_name %>
                                    </option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="mb-3" id="addBenefitDocumentField" style="display: none;">
                            <label id="addBenefitDocumentLabel" class="form-label">Номер пільгового документа</label>
                            <input type="text" class="form-control" id="addBenefitDocument" name="benefitDocument">
                        </div>
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary">Зберегти пасажира</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editPassengerModal" tabindex="-1" aria-labelledby="editPassengerModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPassengerModalLabel">Редагувати пасажира</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editPassengerForm" action="/edit-passenger" method="POST">
                        <input type="hidden" id="editPassengerId" name="passengerId">
                        <div class="mb-3">
                            <label for="editPassengerName" class="form-label">Імʼя</label>
                            <input type="text" class="form-control" id="editPassengerName" name="firstName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPassengerSurname" class="form-label">Прізвище</label>
                            <input type="text" class="form-control" id="editPassengerSurname" name="lastName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBenefit" class="form-label">Пільга</label>
                            <select class="form-select" id="editBenefit" name="benefitId">
                                <option value="">Без пільги</option>
                                <% benefits.forEach(benefit => { %>
                                    <option value="<%= benefit.benefit_id %>"
                                            data-document="<%= benefit.document_name %>">
                                        <%= benefit.benefit_name %>
                                    </option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="mb-3" id="editBenefitDocumentField" style="display: none;">
                            <label id="editBenefitDocumentLabel" class="form-label">Номер пільгового документа</label>
                            <input type="text" class="form-control" id="editBenefitDocument" name="benefitDocument">
                        </div>
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary">Зберегти зміни</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deletePassengerModal" tabindex="-1" aria-labelledby="deletePassengerModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deletePassengerModalLabel">Підтвердження видалення</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Ви дійсно хочете видалити пасажира <span id="deletingPassengerName"></span>?
                    <br>
                    Після цього ви не будете мати доступ до всіх квитків цього пасажира!

                    <div class="modal-footer mt-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                        <button type="submit" class="btn btn-danger" onclick="deletePassenger()">Видалити</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Редагувати профіль</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm" action="javascript:void(0);">
                        <div class="mb-3">
                            <label for="editProfileName" class="form-label">Імʼя</label>
                            <input type="text" class="form-control" id="editProfileName" name="firstName" value="<%= user.user_first_name %>" required>
                        </div>
                        <div class="mb-3">
                            <label for="editProfileSurname" class="form-label">Прізвище</label>
                            <input type="text" class="form-control" id="editProfileSurname" name="lastName" value="<%= user.user_last_name %>"  required>
                        </div>
                        <div class="mb-3">
                            <label for="editProfilePhoneNumber" class="form-label">Номер телефону</label>
                            <input type="tel"
                                   minlength="17" maxlength="17" class="form-control" id="editProfilePhoneNumber"
                                   name="phoneNumber" value="<%= user.phone_number %>"  required>
                        </div>
                        <div class="mb-3">
                            <label for="editProfileEmail" class="form-label">Електронна пошта</label>
                            <input type="email" class="form-control" id="editProfileEmail" name="email" value="<%= user.email %>" required>
                        </div>
                        <div class="d-grid mt-4">
                            <button type="button" class="btn btn-primary" onclick="updateProfile()">Зберегти зміни</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</main>
<script src="js/phoneNumberForm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function showEditForm(id, firstName, lastName, benefitId, benefitDocument) {
        const fields = {
            id: document.getElementById("editPassengerId"),
            firstName: document.getElementById("editPassengerName"),
            lastName: document.getElementById("editPassengerSurname"),
            benefit: document.getElementById("editBenefit"),
            benefitDocument: document.getElementById("editBenefitDocument"),
            benefitField: document.getElementById("editBenefitDocumentField")
        };

        fields.id.value = id;
        fields.firstName.value = firstName;
        fields.lastName.value = lastName;
        fields.benefit.value = benefitId || "";
        fields.benefitDocument.value = benefitDocument || "";

        fields.benefitField.style.display = benefitId ? "block" : "none";
    }

    function toggleBenefitField(benefitSelectId, benefitFieldId, benefitLabelId, benefitInputId) {
        const benefitElement = document.getElementById(benefitSelectId);
        const selectedOption = benefitElement.options[benefitElement.selectedIndex];
        const documentName = selectedOption.getAttribute('data-document');

        const benefitDocumentField = document.getElementById(benefitFieldId);
        const benefitDocumentLabel = document.getElementById(benefitLabelId);
        const benefitDocumentInput = document.getElementById(benefitInputId);

        if (documentName) {
            benefitDocumentField.style.display = 'block';
            benefitDocumentLabel.textContent = documentName;
            benefitDocumentInput.setAttribute('required', 'required');
        } else {
            benefitDocumentField.style.display = 'none';
            benefitDocumentInput.removeAttribute('required');
            benefitDocumentInput.value = '';
        }
    }

    document.getElementById("editBenefit").addEventListener("change", () =>
        toggleBenefitField("editBenefit", "editBenefitDocumentField", "editBenefitDocumentLabel", "editBenefitDocument")
    );

    document.getElementById("addBenefit").addEventListener("change", () =>
        toggleBenefitField("addBenefit", "addBenefitDocumentField", "addBenefitDocumentLabel", "addBenefitDocument")
    );

    const deletePassengerModalElement = document.getElementById('deletePassengerModal');
    const deletePassengerModal = new bootstrap.Modal(deletePassengerModalElement);
    let deletingPassengerId = null;
    deletePassengerModalElement.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        deletingPassengerId = +button.getAttribute('data-bs-passenger-id');
        const passengerName = button.getAttribute('data-bs-passenger-name');
        const passengerNameSpan = document.getElementById('deletingPassengerName');
        passengerNameSpan.textContent = passengerName;
    });

    async function deletePassenger() {
        try {
            const response = await fetch(`/delete-passenger/${deletingPassengerId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
            });

            if (response.ok) {
                location.reload();
            } else {
                const errorData = await response.json();
                deletePassengerModal.hide()
                showErrorAlert(errorData.error || "Помилка при видаленні пасажира");
            }
        } catch (error) {
            console.error(error);
            deletePassengerModal.hide()
            showErrorAlert("Сталася помилка");
        }
    }

    async function updateProfile() {
        try {
            const form = document.getElementById('editProfileForm');
            const formData = new FormData(form);
            const formObject = {};
            formData.forEach((value, key) => {
                if (key === 'phoneNumber') {
                    value = value.replace(/\s+/g, '').replace(/[^\d+]/g, '');
                }
                formObject[key] = value;
            });
            const response = await fetch('/edit-profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formObject)
            });
            if (!response.ok) {
                const errorData = await response.json();
                console.error("Error: ", errorData.errors);
                showErrorAlert(errorData.errors.map(e => e.msg).join('<br>') || "Помилка при зміні профілю");
                return;
            }
            location.reload();
        } catch (error) {
            console.error(error);
            showErrorAlert("Помилка при зміні профілю");
        }
    }

    function showErrorAlert(errorMessage) {
        const Toast = Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: false,
            didOpen: (toast) => {
                toast.onmouseenter = Swal.stopTimer;
                toast.onmouseleave = Swal.resumeTimer;
            }
        });
        Toast.fire({
            icon: "error",
            title: errorMessage
        });
    }

    setupPhoneNumberForm(document.getElementById('editProfilePhoneNumber'), document.getElementById('editProfileForm'))
</script>
</body>
</html>